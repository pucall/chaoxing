name: åˆ·è¯¾ä»»åŠ¡è‡ªåŠ¨åŒ– # æ›´æ¸…æ™°çš„å·¥ä½œæµåç§°

on:
  push:
    branches: [ main ] # å½“æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  schedule:
    # cron è¡¨è¾¾å¼ä¸º UTC æ—¶é—´ã€‚
    # "0 0 * * *" è¡¨ç¤º UTC 0ç‚¹0åˆ†ï¼Œè¿™å¯¹åº”åŒ—äº¬æ—¶é—´ (UTC+8) çš„æ—©ä¸Š 8ç‚¹0åˆ†ã€‚
    - cron: "0 0 * * *"
  workflow_dispatch: # å…è®¸åœ¨ GitHub UI ä¸Šæ‰‹åŠ¨è§¦å‘æ­¤å·¥ä½œæµ

jobs:
  Start:
    runs-on: ubuntu-latest # ä½¿ç”¨æœ€æ–°çš„ Ubuntu runner

    steps:
      - name: ğŸš€ æ‹·è´ä»£ç  (Checkout repository)
        # æ¨èä½¿ç”¨ actions/checkout@v4ï¼Œä»¥è·å–æœ€æ–°åŠŸèƒ½å’Œå®‰å…¨ä¿®å¤
        uses: actions/checkout@v4

      - name: â° æ‰§è¡Œæ—¶æ®µæ£€æŸ¥ (Perform time check - Beijing Time)
        id: time-check # ä¸ºæ­¤æ­¥éª¤è®¾ç½® IDï¼Œä»¥ä¾¿è·å–å…¶è¾“å‡º
        run: |
          echo "è§¦å‘äº‹ä»¶åç§°: $GITHUB_EVENT_NAME"

          if [ "$GITHUB_EVENT_NAME" == "workflow_dispatch" ]; then
              # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ï¼Œè·³è¿‡è„šæœ¬å±‚é¢çš„æ—¶é—´é™åˆ¶ã€‚
              # è¿™é‡Œæˆ‘ä»¬è®¾ç½® timeout_prefix ä¸ºç©ºï¼Œæ„å‘³ç€åœ¨æ‰§è¡Œå‘½ä»¤æ—¶ä¸ä¼šä½¿ç”¨ timeout å‘½ä»¤ã€‚
              echo "æ‰‹åŠ¨è§¦å‘ï¼Œä»»åŠ¡å°†ä¸å—è„šæœ¬å†…æ—¶é—´é™åˆ¶ã€‚"
              echo "timeout_prefix=" >> "$GITHUB_OUTPUT" 
          else
              # å¯¹äº push æˆ– schedule è§¦å‘ï¼Œæ‰§è¡Œæ—¶é—´çª—å£æ ¡éªŒ
              export TZ=Asia/Shanghai # è®¾ç½®æ—¶åŒºä¸ºåŒ—äº¬æ—¶é—´ï¼Œç¡®ä¿æ—¶é—´æ ¡éªŒçš„å‡†ç¡®æ€§
              current_hour=$(date +'%-H') # è·å–å½“å‰å°æ—¶ï¼ˆä¸å¸¦å‰å¯¼é›¶ï¼‰
              current_min=$(date +'%-M')  # è·å–å½“å‰åˆ†é’Ÿï¼ˆä¸å¸¦å‰å¯¼é›¶ï¼‰
              
              echo "å½“å‰åŒ—äº¬æ—¶é—´: $(date +'%H:%M')"

              # æ ¡éªŒæ˜¯å¦åœ¨ 08:00 åˆ° 11:59 çš„æœ‰æ•ˆçª—å£å†…
              if [ "$current_hour" -lt 8 ]; then
                echo "::error::âŒ å½“å‰åŒ—äº¬æ—¶é—´ $(date +'%H:%M')ï¼Œæ—©é—´çª—å£æœªå¼€å¯ (éœ€ >= 08:00)"
                exit 1 # é€€å‡ºå·¥ä½œæµ
              elif [ "$current_hour" -ge 12 ]; then
                echo "::error::âŒ å½“å‰åŒ—äº¬æ—¶é—´ $(date +'%H:%M')ï¼Œåˆé—´çª—å£å·²å…³é—­ (éœ€ < 12:00)"
                exit 1 # é€€å‡ºå·¥ä½œæµ
              else
                # è®¡ç®—åˆ° 12:00 æ•´çš„å‰©ä½™ç§’æ•°
                target_minutes_of_day=$(( 12 * 60 )) # 12ç‚¹æ•´è½¬æ¢ä¸ºåˆ†é’Ÿæ•°
                current_minutes_of_day=$(( current_hour * 60 + current_min )) # å½“å‰æ—¶é—´è½¬æ¢ä¸ºåˆ†é’Ÿæ•°
                
                remain_minutes=$(( target_minutes_of_day - current_minutes_of_day )) # å‰©ä½™åˆ†é’Ÿæ•°
                remain_seconds=$(( remain_minutes * 60 )) # å‰©ä½™ç§’æ•°
                
                echo "âœ… æ—¶æ®µæ£€æŸ¥é€šè¿‡ã€‚å‰©ä½™æœ‰æ•ˆæ—¶é•¿ï¼š${remain_minutes}åˆ†ï¼ˆ${remain_seconds}ç§’ï¼‰"
                # å°† timeout å‘½ä»¤çš„å‰ç¼€ä½œä¸º Job Outputï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
                echo "timeout_prefix=timeout --preserve-status $remain_seconds" >> "$GITHUB_OUTPUT"
              fi
          fi

      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ (Set up Python environment)
        # è¿™æ˜¯è§£å†³ ModuleNotFoundError çš„ç¬¬ä¸€æ­¥
        uses: actions/setup-python@v5
        with:
          # æŒ‡å®š Python ç‰ˆæœ¬ã€‚å»ºè®®ä½¿ç”¨ä¸€ä¸ªå…·ä½“çš„ç¨³å®šç‰ˆæœ¬ï¼Œå¦‚ '3.9'ã€'3.10' æˆ– '3.11'
          # è¯·æ ¹æ®ä½ çš„ main.py ä»£ç å…¼å®¹æ€§é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„ç‰ˆæœ¬
          python-version: '3.12' 

      - name: ğŸ“¦ å®‰è£… Python ä¾èµ– (Install Python dependencies)
        # è¿™æ˜¯è§£å†³ ModuleNotFoundError çš„å…³é”®æ­¥éª¤
        run: |
          echo "æ­£åœ¨å‡çº§ pip å·¥å…·è‡ªèº«..."
          python -m pip install --upgrade pip # å‡çº§ pipï¼Œç¡®ä¿å…¶ä¸ºæœ€æ–°ç‰ˆæœ¬
          echo "æ­£åœ¨å®‰è£… requirements.txt ä¸­åˆ—å‡ºçš„ä¾èµ–..."
          pip install -r requirements.txt # å®‰è£…æ‰€æœ‰é¡¹ç›®ä¾èµ–
          echo "æ‰€æœ‰ä¾èµ–å®‰è£…å®Œæˆã€‚"

      - name: ğŸš€ æ‰§è¡Œåˆ·è¯¾ä»»åŠ¡ (Run main script)
        # 'if: ${{ success() }}' ç¡®ä¿åªæœ‰å½“å‰é¢æ‰€æœ‰æ­¥éª¤éƒ½æˆåŠŸæ—¶æ‰æ‰§è¡Œæ­¤ä»»åŠ¡
        if: ${{ success() }}
        env:
          # ä» GitHub Secrets ä¸­å®‰å…¨åœ°è·å–æ•æ„Ÿä¿¡æ¯
          # è¯·ç¡®ä¿ä½ åœ¨ä»“åº“è®¾ç½®ä¸­é…ç½®äº† USR å’Œ PSW ä¸¤ä¸ª Secret
          ACCOUNT_USR: ${{ secrets.USR }} 
          ACCOUNT_PSW: ${{ secrets.PSW }}
          # ä» GitHub Variables ä¸­è·å–éæ•æ„Ÿé…ç½®ä¿¡æ¯
          # è¯·ç¡®ä¿ä½ åœ¨ä»“åº“è®¾ç½®ä¸­é…ç½®äº† LEESON è¿™ä¸ª Variable
          COURSE_LEESON: ${{ vars.LEESON }} 
        run: |
          echo "å¼€å§‹æ‰§è¡Œ main.py è„šæœ¬..."
          # ä½¿ç”¨ timeout_prefix å˜é‡æ¥åŠ¨æ€å†³å®šæ˜¯å¦ä½¿ç”¨ timeout å‘½ä»¤åŠå…¶å‚æ•°
          # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ï¼Œtimeout_prefix ä¸ºç©ºï¼Œåˆ™ä¸ä¼šæ‰§è¡Œ timeout å‘½ä»¤
          # å¦‚æœæ˜¯å®šæ—¶æˆ–pushè§¦å‘ï¼Œtimeout_prefix åŒ…å« timeout å‘½ä»¤å’Œå‰©ä½™ç§’æ•°
          ${{ steps.time-check.outputs.timeout_prefix }} \
            python main.py -u "$ACCOUNT_USR" -p "$ACCOUNT_PSW" -l "$COURSE_LEESON" -a continue
          echo "main.py è„šæœ¬æ‰§è¡Œå®Œæ¯•æˆ–å› è¶…æ—¶è€Œç»ˆæ­¢ã€‚"
