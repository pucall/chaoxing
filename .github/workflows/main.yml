name: åˆ·è¯¾ä»»åŠ¡è‡ªåŠ¨åŒ–

on:
  push:
    branches: [ main ]
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

env:
  # å®šä¹‰è§‚çœ‹æ—¶é•¿å˜é‡ï¼ˆåˆ†é’Ÿï¼‰
  # è‡ªåŠ¨è§¦å‘ï¼š0=åˆ°12ç‚¹ï¼Œ>0=æŒ‡å®šåˆ†é’Ÿæ•°
  # æ‰‹åŠ¨è§¦å‘ï¼š0=4å°æ—¶ï¼Œ>0=æŒ‡å®šåˆ†é’Ÿæ•°
  WATCH_DURATION_MINUTES: ${{ vars.WATCH_DURATION || 0 }}

jobs:
  Start:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸš€ æ‹·è´ä»£ç 
        uses: actions/checkout@v4

      - name: â° æ‰§è¡Œæ—¶æ®µæ£€æŸ¥
        id: time-check
        env:
          WATCH_DURATION: ${{ env.WATCH_DURATION_MINUTES }}
        run: |
          echo "è§¦å‘äº‹ä»¶åç§°: $GITHUB_EVENT_NAME"
          echo "è®¾ç½®çš„è§‚çœ‹æ—¶é•¿: ${WATCH_DURATION} åˆ†é’Ÿ"

          if [ "$GITHUB_EVENT_NAME" == "workflow_dispatch" ]; then
              # æ‰‹åŠ¨è§¦å‘é€»è¾‘
              if [ "${WATCH_DURATION}" -eq 0 ]; then
                  # æ‰‹åŠ¨è§¦å‘ + æ—¶é•¿ä¸º0 = 4å°æ—¶
                  timeout_seconds=$(( 4 * 60 * 60 ))
                  echo "æ‰‹åŠ¨è§¦å‘ï¼Œé»˜è®¤è§‚çœ‹æ—¶é•¿: 4å°æ—¶ (${timeout_seconds}ç§’)"
                  echo "timeout_prefix=timeout --preserve-status $timeout_seconds" >> "$GITHUB_OUTPUT"
              else
                  # æ‰‹åŠ¨è§¦å‘ + æ—¶é•¿>0 = æŒ‡å®šåˆ†é’Ÿ
                  timeout_seconds=$(( WATCH_DURATION * 60 ))
                  echo "æ‰‹åŠ¨è§¦å‘ï¼Œè‡ªå®šä¹‰è§‚çœ‹æ—¶é•¿: ${WATCH_DURATION} åˆ†é’Ÿ"
                  echo "timeout_prefix=timeout --preserve-status $timeout_seconds" >> "$GITHUB_OUTPUT"
              fi
          else
              # è‡ªåŠ¨è§¦å‘é€»è¾‘ï¼ˆschedule/pushï¼‰
              export TZ=Asia/Shanghai
              current_hour=$(date +'%-H')
              current_min=$(date +'%-M')
              
              echo "å½“å‰åŒ—äº¬æ—¶é—´: $(date +'%H:%M')"

              # æ ¡éªŒæ˜¯å¦åœ¨ 08:00 åˆ° 11:59 çš„æœ‰æ•ˆçª—å£å†…
              if [ "$current_hour" -lt 8 ]; then
                echo "::error::âŒ å½“å‰åŒ—äº¬æ—¶é—´ $(date +'%H:%M')ï¼Œæ—©é—´çª—å£æœªå¼€å¯ (éœ€ >= 08:00)"
                exit 1
              elif [ "$current_hour" -ge 12 ]; then
                echo "::error::âŒ å½“å‰åŒ—äº¬æ—¶é—´ $(date +'%H:%M')ï¼Œåˆé—´çª—å£å·²å…³é—­ (éœ€ < 12:00)"
                exit 1
              else
                # è®¡ç®—åˆ° 12:00 æ•´çš„å‰©ä½™ç§’æ•°
                target_minutes_of_day=$(( 12 * 60 ))
                current_minutes_of_day=$(( current_hour * 60 + current_min ))
                
                remain_minutes=$(( target_minutes_of_day - current_minutes_of_day ))
                remain_seconds=$(( remain_minutes * 60 ))
                
                if [ "${WATCH_DURATION}" -eq 0 ]; then
                  # è‡ªåŠ¨è§¦å‘ + æ—¶é•¿ä¸º0 = åˆ°12ç‚¹
                  final_seconds=$remain_seconds
                  final_minutes=$remain_minutes
                  echo "âœ… è‡ªåŠ¨è§¦å‘ï¼Œä½¿ç”¨é»˜è®¤æ—¶é•¿åˆ°12ç‚¹: ${final_minutes} åˆ†é’Ÿ"
                else
                  # è‡ªåŠ¨è§¦å‘ + æ—¶é•¿>0 = æŒ‡å®šåˆ†é’Ÿï¼ˆä¸èƒ½è¶…è¿‡12ç‚¹ï¼‰
                  custom_seconds=$(( WATCH_DURATION * 60 ))
                  if [ "$custom_seconds" -lt "$remain_seconds" ]; then
                    final_seconds=$custom_seconds
                    final_minutes=$WATCH_DURATION
                    echo "âœ… è‡ªåŠ¨è§¦å‘ï¼Œä½¿ç”¨è‡ªå®šä¹‰è§‚çœ‹æ—¶é•¿: ${final_minutes} åˆ†é’Ÿ"
                  else
                    final_seconds=$remain_seconds
                    final_minutes=$remain_minutes
                    echo "âœ… è‡ªåŠ¨è§¦å‘ï¼Œè‡ªå®šä¹‰æ—¶é•¿è¶…è¿‡çª—å£é™åˆ¶ï¼Œä½¿ç”¨å‰©ä½™çª—å£æ—¶é•¿: ${final_minutes} åˆ†é’Ÿ"
                  fi
                fi
                
                echo "æœ€ç»ˆæ‰§è¡Œæ—¶é•¿ï¼š${final_minutes}åˆ†ï¼ˆ${final_seconds}ç§’ï¼‰"
                echo "timeout_prefix=timeout --preserve-status $final_seconds" >> "$GITHUB_OUTPUT"
              fi
          fi

      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: ğŸ“¦ å®‰è£… Python ä¾èµ–
        run: |
          echo "æ­£åœ¨å‡çº§ pip å·¥å…·è‡ªèº«..."
          python -m pip install --upgrade pip
          echo "æ­£åœ¨å®‰è£… requirements.txt ä¸­åˆ—å‡ºçš„ä¾èµ–..."
          pip install -r requirements.txt
          echo "æ‰€æœ‰ä¾èµ–å®‰è£…å®Œæˆã€‚"

      - name: ğŸš€ æ‰§è¡Œåˆ·è¯¾ä»»åŠ¡
        if: ${{ success() }}
        env:
          ACCOUNT_USR: ${{ secrets.USR }}
          ACCOUNT_PSW: ${{ secrets.PSW }}
          COURSE_LESSON: ${{ vars.LESSON }}
        run: |
          echo "å¼€å§‹æ‰§è¡Œ main.py è„šæœ¬..."
          ${{ steps.time-check.outputs.timeout_prefix }} \
            python main.py -u "$ACCOUNT_USR" -p "$ACCOUNT_PSW" -l "$COURSE_LESSON" -a continue
          echo "main.py è„šæœ¬æ‰§è¡Œå®Œæ¯•æˆ–å› è¶…æ—¶è€Œç»ˆæ­¢ã€‚"
